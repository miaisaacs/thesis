---
title: "Data Analysis"
author: "Mia Isaacs"
date: "2025-03-27"
output: github_document
---

### load packages

```{r}
library(tidyverse)
library(Biostrings)
library(Pviz)
library(Gviz)
library(stringr)
library(GenomicRanges)
library(preprocessCore) 
library(mclust) 
```

### view dataset

```{r}
dengueIgG_all = read_csv("data/Dengue_data_analysis_IgG.csv") |> 
  janitor::clean_names()

view(dengueIgG_all)
```

### remove unncessary variables
```{r}
dengueIgG_clean <- dengueIgG_all |> 
  select(-accession, -p_val_acute_conv, -p_adjust_acute_conv, -p_val_acute_nc, -p_adjust_acute_nc, -p_val_conv_nc,
         -p_adjust_conv_nc, -x10, -acute, -conv, -nc, -row_total_x, -control, -d1_acute, -d1_conv, -d2_acute,
         -d2_conv, -d3_acute, -d3_conv, -d3d4_acute, -d3d4_conv, -d4_acute, -d4_conv,z_conv, -zd_conv, -zdyfv_conv,
         -zyfv_conv, -row_total_y, -z_conv)

head(dengueIgG_clean)
```

### check for missing values (all good!)
```{r}
sum(is.na(dengueIgG_clean))
```

### convert to long format for easier manipulation
```{r}
dengueIgG_long <- dengueIgG_clean |> 
  pivot_longer(cols = matches("uwa_"),
               names_to = "sample",
               values_to = "fluorescence")

head(dengueIgG_long)
```

### add log transformed fluorescence values for future analysis
```{r}
dengueIgG_transform <- dengueIgG_long |> 
  mutate(fluorescence_log = log(fluorescence))

head(dengueIgG_transform)
```

## prepare data for quantile normalization

### extract serotype from sample name
```{r}
dengueIgG_serotype <- dengueIgG_transform |> 
  mutate(serotype = str_extract(sample, "_(d[1-4]d[1-4]|d[1-4]|z|zd|zdyfv|zyfv|nc)_") |>  
           str_replace_all("_", ""))
```

### separate into each serotype or virus
```{r}
serotype_list <- dengueIgG_serotype |> 
  group_split(serotype)
```

### write function for quantile normalization
```{r}
quantile_normalize <- function(df) {
  # ensure samples are ordered consistently
  df <- df |>  arrange(sample) 
  
  # extract fluorescence values and convert them to a matrix
  fluorescence_matrix <- as.matrix(df |>  select(fluorescence))
  
  # perform quantile normalization
  fluorescence_norm <- normalize.quantiles(fluorescence_matrix)
  
  # add the normalized values back to the data frame
  df$fluorescence_norm <- as.vector(fluorescence_norm)
  
  return(df)
}
```

### normalize across each serotype
```{r}
# create an empty list to store the normalized data
serotype_list_norm <- list()

# loop through each serotype group and apply quantile normalization
for (i in seq_along(serotype_list)) {
  # apply quantile normalization to the current group
  serotype_list_norm[[i]] <- quantile_normalize(serotype_list[[i]])
}

dengueIgG_norm <- bind_rows(serotype_list_norm)

head(dengueIgG_norm)
```

```{r}
dengueIgG_norm |> 
  summarize(
    mean_fluorescence = mean(fluorescence, na.rm = TRUE),
    median_fluorescence = median(fluorescence, na.rm = TRUE),
    sd_fluorescence = sd(fluorescence, na.rm = TRUE),
    
    mean_fluorescence_norm = mean(fluorescence_norm, na.rm = TRUE),
    median_fluorescence_norm = median(fluorescence_norm, na.rm = TRUE),
    sd_fluorescence_norm = sd(fluorescence_norm, na.rm = TRUE)
  )
```


